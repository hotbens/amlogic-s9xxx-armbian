#==========================================================================
# Description: Build Armbian arm64 server image (Final Fixed for TSPi RK3566)
# Copyright (C) 2021 https://github.com/ophub/amlogic-s9xxx-armbian
#==========================================================================

name: Build Armbian arm64 server image

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      set_release:
        description: "Select OS Release."
        required: false
        default: "bookworm"
        type: choice
        options:
          - bookworm
          - jammy
      armbian_edition:
        description: "Select image edition type."
        required: false
        default: "server"
        type: choice
        options:
          - server
          - desktop

env:
  TZ: Etc/UTC
  ROOTFS_SCRIPT: compile-kernel/tools/script/docker/build_armbian_rootfs_file.sh

jobs:
  build:
    runs-on: ubuntu-24.04
    if: ${{ github.event.repository.owner.id }} == ${{ github.event.sender.id }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Initialization environment
        id: init
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          docker rmi -f $(docker images -q) 2>/dev/null || true
          [[ -n "${AGENT_TOOLSDIRECTORY}" ]] && sudo rm -rf "${AGENT_TOOLSDIRECTORY}"
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android 2>/dev/null
          sudo swapoff -a
          sudo rm -f /swapfile /mnt/swapfile
          sudo -E apt-get -y update
          sudo -E apt-get -y purge azure-cli ghc* zulu* llvm* firefox google* dotnet* powershell openjdk* mongodb* moby* || true
          sudo -E apt-get -y install $(curl -fsSL https://ophub.org/ubuntu2404-build-armbian-depends)
          sudo -E systemctl daemon-reload
          sudo -E apt-get -y autoremove --purge
          sudo -E apt-get clean
          sudo sed -i '/NVM_DIR/d;/skel/d' /root/{.bashrc,.profile}
          sudo rm -rf ~/{.cargo,.dotnet,.rustup}
          sudo -E timedatectl set-timezone "${TZ:-Etc/UTC}"
          sudo -E ntpdate ntp.ubuntu.com 0.pool.ntp.org || true
          sudo -E timedatectl set-ntp true
          date -u
          timedatectl status || true
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: Create simulated physical disk
        run: |
          mnt_size=$(expr $(df -h /mnt | tail -1 | awk '{print $4}' | sed 's/[[:alpha:]]//g' | sed 's/\..*//') - 1)
          root_size=$(expr $(df -h / | tail -1 | awk '{print $4}' | sed 's/[[:alpha:]]//g' | sed 's/\..*//') - 4)
          sudo truncate -s "${mnt_size}"G /mnt/mnt.img
          sudo truncate -s "${root_size}"G /root.img
          sudo losetup /dev/loop6 /mnt/mnt.img
          sudo losetup /dev/loop7 /root.img
          sudo pvcreate /dev/loop6
          sudo pvcreate /dev/loop7
          sudo vgcreate github /dev/loop6 /dev/loop7
          sudo lvcreate -n runner -l 100%FREE github
          sudo mkfs.xfs -f -i sparse=0 -b size=4096 /dev/github/runner
          sudo mkdir -p /builder
          sudo mount /dev/github/runner /builder
          sudo chown -R runner:runner /builder
          df -Th
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: Download source code
        id: down
        working-directory: /builder
        if: ${{ steps.init.outputs.status }} == 'success' && !cancelled()
        run: |
          df -hT ${PWD}
          git clone -q --single-branch --depth=1 --branch=main https://github.com/armbian/build.git build
          ln -sf /builder/build ${{ github.workspace }}/build
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: ğŸ”§ Inject TSPi Drivers (Force Mode)
        working-directory: /builder
        if: ${{ steps.down.outputs.status }} == 'success' && !cancelled()
        run: |
          # =======================================================
          # 0. å‡†å¤‡å·¥ä½œ
          # =======================================================
          PATCH_DIR="build/userpatches/kernel/rockchip64-current"
          mkdir -p $PATCH_DIR
          mkdir -p build/userpatches/extensions
          mkdir -p build/userpatches/overlay

          echo "æ­£åœ¨ç”Ÿæˆé©±åŠ¨æºç ..."

          # =======================================================
          # 1. ç”Ÿæˆå±å¹•é©±åŠ¨æºç æ–‡ä»¶ (panel-jd9365da-h3.c)
          # =======================================================
          cat << 'EOF' > panel-jd9365da-h3.c
          // SPDX-License-Identifier: GPL-2.0
          #include <linux/delay.h>
          #include <linux/gpio/consumer.h>
          #include <linux/module.h>
          #include <linux/of.h>
          #include <linux/regulator/consumer.h>
          #include <drm/drm_mipi_dsi.h>
          #include <drm/drm_modes.h>
          #include <drm/drm_panel.h>

          struct jd9365da_panel {
          	struct drm_panel panel;
          	struct mipi_dsi_device *dsi;
          	struct gpio_desc *reset_gpio;
          };

          static inline struct jd9365da_panel *to_jd9365da_panel(struct drm_panel *panel) {
          	return container_of(panel, struct jd9365da_panel, panel);
          }

          static int jd9365da_init_sequence(struct mipi_dsi_device *dsi) {
          	mipi_dsi_dcs_write(dsi, 0xE0, (u8[]){0x00}, 1);
          	mipi_dsi_dcs_write(dsi, 0xE1, (u8[]){0x93}, 1);
          	mipi_dsi_dcs_write(dsi, 0xE2, (u8[]){0x65}, 1);
          	mipi_dsi_dcs_write(dsi, 0xE3, (u8[]){0xF8}, 1);
          	mipi_dsi_dcs_write(dsi, 0x80, (u8[]){0x03}, 1);
          	mipi_dsi_dcs_write(dsi, 0xE0, (u8[]){0x01}, 1);
          	mipi_dsi_dcs_write(dsi, 0x00, (u8[]){0x00}, 1);
          	mipi_dsi_dcs_write(dsi, 0x01, (u8[]){0x3B}, 1);
          	mipi_dsi_dcs_write(dsi, 0x0C, (u8[]){0x74}, 1);
          	mipi_dsi_dcs_write(dsi, 0xE0, (u8[]){0x04}, 1);
          	mipi_dsi_dcs_write(dsi, 0x00, (u8[]){0x0E}, 1);
          	mipi_dsi_dcs_write(dsi, 0x02, (u8[]){0xB3}, 1);
          	mipi_dsi_dcs_write(dsi, 0x09, (u8[]){0x61}, 1);
          	mipi_dsi_dcs_write(dsi, 0x0E, (u8[]){0x48}, 1);
          	mipi_dsi_dcs_write(dsi, 0xE0, (u8[]){0x00}, 1);
          	mipi_dsi_dcs_write(dsi, 0xE6, (u8[]){0x02}, 1);
          	mipi_dsi_dcs_write(dsi, 0xE7, (u8[]){0x0C}, 1);
          	return 0;
          }

          static int jd9365da_prepare(struct drm_panel *panel) {
          	struct jd9365da_panel *ctx = to_jd9365da_panel(panel);
          	gpiod_set_value(ctx->reset_gpio, 1);
          	msleep(10);
          	gpiod_set_value(ctx->reset_gpio, 0);
          	msleep(20);
          	gpiod_set_value(ctx->reset_gpio, 1);
          	msleep(120);
          	jd9365da_init_sequence(ctx->dsi);
          	return mipi_dsi_dcs_exit_sleep_mode(ctx->dsi);
          }

          static int jd9365da_enable(struct drm_panel *panel) {
          	struct jd9365da_panel *ctx = to_jd9365da_panel(panel);
          	msleep(120);
          	return mipi_dsi_dcs_set_display_on(ctx->dsi);
          }

          static int jd9365da_disable(struct drm_panel *panel) {
          	struct jd9365da_panel *ctx = to_jd9365da_panel(panel);
          	return mipi_dsi_
