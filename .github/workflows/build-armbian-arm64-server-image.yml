#==========================================================================
# Description: Build Armbian arm64 server image
# Copyright (C) 2021 https://github.com/ophub/amlogic-s9xxx-armbian
#==========================================================================

name: Build Armbian arm64 server image

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      set_release:
        description: "Select OS Release."
        required: false
        default: "trixie"
        type: choice
        options:
          - trixie
          - bookworm
          - noble
          - jammy
      armbian_board:
        description: "Select device board."
        required: false
        default: "all"
        type: choice
        options:
          - all
          - top55
          - after55
          - a311d-oes_s922x-oes-plus_wxy-oect
          - s905d_s905x3_s912_s922x-ct2000
          - a311d
          - a311d-oes
          - alark35-3500
          - anas3035
          - aio-3399b
          - beikeyun
          - chainedbox
          - crrc
          - dc-a588
          - dg3399
          - dg-tn3568
          - dlfr100
          - e20c
          - e25
          - eaidk-610
          - emb3531
          - fine3399
          - firefly-rk3399
          - fmx1-pro
          - jp-tvbox
          - h28k
          - h66k
          - h68k
          - h69k
          - h88k
          - h88k-v3
          - h96-max-m2
          - hs530r
          - hugsun-x99
          - ipc-r
          - king3399
          - kylin3399
          - lckfb-tspi
          - leez
          - lx-r3s
          - mrkaio-m68s
          - nanopc-t6
          - nanopi-r5c
          - nanopi-r5s
          - orangepi-5-plus
          - orangepi-5b
          - panther-x2
          - photonicat
          - r66s
          - r68s
          - renegade-rk3328
          - rk3318-box
          - rock5b
          - rock5c
          - ruisen-box
          - s905
          - s905-beelink-mini
          - s905-mxqpro-plus
          - s905d
          - s905d-ki-pro
          - s905d-sml5442tw
          - s905l
          - s905l-aurora-1s
          - s905l-b860av21u
          - s905l-mg101
          - s905l2
          - s905l2-e900v21e
          - s905l2-wojia
          - s905l3
          - s905l3-cm211
          - s905l3-unt400g1
          - s905l3-unt402a
          - s905l3a
          - s905l3a-cm311
          - s905l3a-m401a
          - s905l3b
          - s905l3b-e900v21d
          - s905l3b-e900v22d
          - s905l3b-e900v22e
          - s905l3b-ip103h
          - s905l3b-rg020et-ca
          - s905l3b-unt403a
          - s905lb-ipbs9505
          - s905lb-q96-mini
          - s905lb-r3300l
          - s905mb
          - s905w
          - s905w-w95
          - s905w-x96-mini
          - s905w-x96w
          - s905x
          - s905x-b860h
          - s905x-nexbox-a95x
          - s905x-t95
          - s905x-tbee
          - s905x-tx9
          - s905x2
          - s905x2-km3
          - s905x2-x96max-2g
          - s905x2-hg680fj
          - s905x3
          - s905x3-2101
          - s905x3-a100
          - s905x3-a95xf3
          - s905x3-a95xf3-gb
          - s905x3-b
          - s905x3-h96max
          - s905x3-hk1
          - s905x3-ip1001m
          - s905x3-q1
          - s905x3-q2
          - s905x3-tx3
          - s905x3-tx3-bz
          - s905x3-ugoosx3
          - s905x3-whale
          - s905x3-x88-pro-x3
          - s905x3-x96air
          - s905x3-x96air-gb
          - s905x3-x96max
          - s912
          - s912-h96pro-plus
          - s912-m8s-pro
          - s912-nexbox-a1
          - s912-nexbox-a2
          - s912-onecloudpro
          - s912-phicomm-t1
          - s912-t95z-plus
          - s912-tx8-max
          - s912-tx9-pro-2g
          - s912-tx9-pro-3g
          - s912-x92
          - s912-zyxq-fake
          - s922x
          - s922x-ct2000
          - s922x-gtking
          - s922x-gtkingpro-h
          - s922x-odroid-n2
          - s922x-oes-plus
          - s922x-reva
          - s922x-ugoos-am6
          - seewo-sv21
          - smart-am40
          - smart-am60
          - station-m1
          - station-m2
          - sv-33a6x
          - swan1-w28
          - sw799
          - tanix-tx6
          - tb-ls3399
          - tn3399
          - tpm312
          - tqc-a01
          - tvi3315a
          - vplus
          - wocyber-a3
          - wxy-oect
          - wxy-oect-mod
          - xiaobao
          - yskj
          - zcube1-max
          - zk-r39a
          - zysj
      armbian_kernel:
        description: "Select kernel version."
        required: false
        default: "6.1.y_6.12.y"
        type: choice
        options:
          - 5.4.y
          - 5.10.y
          - 5.15.y
          - 6.1.y
          - 6.6.y
          - 6.12.y
          - 5.4.y_5.10.y
          - 5.15.y_6.1.y
          - 6.1.y_6.12.y
          - 6.1.y_6.6.y
          - 6.6.y_6.12.y
      auto_kernel:
        description: "Auto use the latest kernel."
        required: false
        default: true
        type: boolean
      kernel_repo:
        description: "Set the kernel repository."
        required: false
        default: "ophub/kernel"
        type: choice
        options:
          - ophub/kernel
      kernel_usage:
        description: "Set the tags of the stable kernel."
        required: false
        default: "stable"
        type: choice
        options:
          - stable
          - flippy
          - beta
      armbian_fstype:
        description: "Select armbian rootfs type."
        required: false
        default: "ext4"
        type: choice
        options:
          - ext4
          - btrfs
      armbian_edition:
        description: "Select image edition type."
        required: false
        default: "server"
        type: choice
        options:
          - server
          - desktop
          - beta
      builder_name:
        description: "Set Armbian builder signature."
        required: false
        default: "ophub"
        type: choice
        options:
          - ophub
          - angel

env:
  TZ: Etc/UTC
  ROOTFS_SCRIPT: compile-kernel/tools/script/docker/build_armbian_rootfs_file.sh

jobs:
  build:
    runs-on: ubuntu-24.04
    if: ${{ github.event.repository.owner.id }} == ${{ github.event.sender.id }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Initialization environment
        id: init
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          docker rmi -f $(docker images -q) 2>/dev/null || true
          [[ -n "${AGENT_TOOLSDIRECTORY}" ]] && sudo rm -rf "${AGENT_TOOLSDIRECTORY}"
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android 2>/dev/null
          sudo swapoff -a
          sudo rm -f /swapfile /mnt/swapfile
          sudo -E apt-get -y update
          sudo -E apt-get -y purge azure-cli ghc* zulu* llvm* firefox google* dotnet* powershell openjdk* mongodb* moby* || true
          sudo -E apt-get -y install $(curl -fsSL https://ophub.org/ubuntu2404-build-armbian-depends)
          sudo -E systemctl daemon-reload
          #sudo -E apt-get -y full-upgrade
          sudo -E apt-get -y autoremove --purge
          sudo -E apt-get clean
          sudo sed -i '/NVM_DIR/d;/skel/d' /root/{.bashrc,.profile}
          sudo rm -rf ~/{.cargo,.dotnet,.rustup}
          sudo -E timedatectl set-timezone "${TZ:-Etc/UTC}"
          sudo -E ntpdate ntp.ubuntu.com 0.pool.ntp.org || true
          sudo -E timedatectl set-ntp true
          date -u
          timedatectl status || true
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: Create simulated physical disk
        run: |
          mnt_size=$(expr $(df -h /mnt | tail -1 | awk '{print $4}' | sed 's/[[:alpha:]]//g' | sed 's/\..*//') - 1)
          root_size=$(expr $(df -h / | tail -1 | awk '{print $4}' | sed 's/[[:alpha:]]//g' | sed 's/\..*//') - 4)
          sudo truncate -s "${mnt_size}"G /mnt/mnt.img
          sudo truncate -s "${root_size}"G /root.img
          sudo losetup /dev/loop6 /mnt/mnt.img
          sudo losetup /dev/loop7 /root.img
          sudo pvcreate /dev/loop6
          sudo pvcreate /dev/loop7
          sudo vgcreate github /dev/loop6 /dev/loop7
          sudo lvcreate -n runner -l 100%FREE github
          sudo mkfs.xfs -f -i sparse=0 -b size=4096 /dev/github/runner
          sudo mkdir -p /builder
          sudo mount /dev/github/runner /builder
          sudo chown -R runner:runner /builder
          df -Th
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: Download source code
        id: down
        working-directory: /builder
        if: ${{ steps.init.outputs.status }} == 'success' && !cancelled()
        run: |
          df -hT ${PWD}
          git clone -q --single-branch --depth=1 --branch=main https://github.com/armbian/build.git build
          ln -sf /builder/build ${{ github.workspace }}/build
          ln -sf /builder/build /home/runner/work/_actions/ophub/amlogic-s9xxx-armbian/main/build
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: ğŸ”§ Inject TSPi Drivers (Screen + Touch)
        working-directory: /builder
        if: ${{ steps.down.outputs.status }} == 'success' && !cancelled()
        run: |
          # =======================================================
          # 0. ä¿®å¤ç›®å½•ç»“æ„ (è§£å†³ Extension search Directory æŠ¥é”™)
          # =======================================================
          # ç¼–è¯‘è„šæœ¬éœ€è¦è¿™äº›ç›®å½•å­˜åœ¨ï¼Œå³ä½¿æ˜¯ç©ºçš„
          mkdir -p build/userpatches/extensions
          mkdir -p build/userpatches/overlay
          
          # å®šä¹‰è¡¥ä¸ç›®å½• (é’ˆå¯¹ RK3566 6.1.x å†…æ ¸)
          PATCH_DIR="build/userpatches/kernel/rockchip64-current"
          mkdir -p $PATCH_DIR

          echo "æ­£åœ¨æ³¨å…¥é©±åŠ¨è¡¥ä¸åˆ°: $PATCH_DIR"

          # =======================================================
          # 1. ç”Ÿæˆå±å¹•é©±åŠ¨æºç  (JD9365DA-H3)
          # =======================================================
          cat << 'EOF' > $PATCH_DIR/001-add-jd9365da-driver.patch
          diff --git a/drivers/gpu/drm/panel/Kconfig b/drivers/gpu/drm/panel/Kconfig
          index 1234567..89abcdef 100644
          --- a/drivers/gpu/drm/panel/Kconfig
          +++ b/drivers/gpu/drm/panel/Kconfig
          @@ -450,3 +450,10 @@ config DRM_PANEL_JDI_LT070ME05000
          +config DRM_PANEL_JD9365DA_H3
          +	tristate "QY101003A0-00 JD9365DA-H3 panel"
          +	depends on OF && DRM_MIPI_DSI
          +	depends on BACKLIGHT_CLASS_DEVICE
          +	help
          +	  Support for QY101003A0-00 10.1 inch 800x1280 DSI panel.
          +
           diff --git a/drivers/gpu/drm/panel/Makefile b/drivers/gpu/drm/panel/Makefile
           index 1234567..89abcdef 100644
           --- a/drivers/gpu/drm/panel/Makefile
           +++ b/drivers/gpu/drm/panel/Makefile
           @@ -45,3 +45,4 @@ obj-$(CONFIG_DRM_PANEL_JDI_LT070ME05000) += panel-jdi-lt070me05000.o
           +obj-$(CONFIG_DRM_PANEL_JD9365DA_H3) += panel-jd9365da-h3.o
           diff --git a/drivers/gpu/drm/panel/panel-jd9365da-h3.c b/drivers/gpu/drm/panel/panel-jd9365da-h3.c
           new file mode 100644
           index 0000000..1234567
           --- /dev/null
           +++ b/drivers/gpu/drm/panel/panel-jd9365da-h3.c
           @@ -0,0 +1,230 @@
           +// SPDX-License-Identifier: GPL-2.0
           +#include <linux/delay.h>
           +#include <linux/gpio/consumer.h>
           +#include <linux/module.h>
           +#include <linux/of.h>
           +#include <linux/regulator/consumer.h>
           +#include <drm/drm_mipi_dsi.h>
           +#include <drm/drm_modes.h>
           +#include <drm/drm_panel.h>
           +
           +struct jd9365da_panel {
           +	struct drm_panel panel;
           +	struct mipi_dsi_device *dsi;
           +	struct gpio_desc *reset_gpio;
           +};
           +
           +static inline struct jd9365da_panel *to_jd9365da_panel(struct drm_panel *panel) {
           +	return container_of(panel, struct jd9365da_panel, panel);
           +}
           +
           +static int jd9365da_init_sequence(struct mipi_dsi_device *dsi) {
           +	mipi_dsi_dcs_write(dsi, 0xE0, (u8[]){0x00}, 1);
           +	mipi_dsi_dcs_write(dsi, 0xE1, (u8[]){0x93}, 1);
           +	mipi_dsi_dcs_write(dsi, 0xE2, (u8[]){0x65}, 1);
           +	mipi_dsi_dcs_write(dsi, 0xE3, (u8[]){0xF8}, 1);
           +	mipi_dsi_dcs_write(dsi, 0x80, (u8[]){0x03}, 1);
           +	mipi_dsi_dcs_write(dsi, 0xE0, (u8[]){0x01}, 1);
           +	mipi_dsi_dcs_write(dsi, 0x00, (u8[]){0x00}, 1);
           +	mipi_dsi_dcs_write(dsi, 0x01, (u8[]){0x3B}, 1);
           +	mipi_dsi_dcs_write(dsi, 0x0C, (u8[]){0x74}, 1);
           +	mipi_dsi_dcs_write(dsi, 0xE0, (u8[]){0x04}, 1);
           +	mipi_dsi_dcs_write(dsi, 0x00, (u8[]){0x0E}, 1);
           +	mipi_dsi_dcs_write(dsi, 0x02, (u8[]){0xB3}, 1);
           +	mipi_dsi_dcs_write(dsi, 0x09, (u8[]){0x61}, 1);
           +	mipi_dsi_dcs_write(dsi, 0x0E, (u8[]){0x48}, 1);
           +	mipi_dsi_dcs_write(dsi, 0xE0, (u8[]){0x00}, 1);
           +	mipi_dsi_dcs_write(dsi, 0xE6, (u8[]){0x02}, 1);
           +	mipi_dsi_dcs_write(dsi, 0xE7, (u8[]){0x0C}, 1);
           +	return 0;
           +}
           +
           +static int jd9365da_prepare(struct drm_panel *panel) {
           +	struct jd9365da_panel *ctx = to_jd9365da_panel(panel);
           +	gpiod_set_value(ctx->reset_gpio, 1);
           +	msleep(10);
           +	gpiod_set_value(ctx->reset_gpio, 0);
           +	msleep(20);
           +	gpiod_set_value(ctx->reset_gpio, 1);
           +	msleep(120);
           +	jd9365da_init_sequence(ctx->dsi);
           +	return mipi_dsi_dcs_exit_sleep_mode(ctx->dsi);
           +}
           +
           +static int jd9365da_enable(struct drm_panel *panel) {
           +	struct jd9365da_panel *ctx = to_jd9365da_panel(panel);
           +	msleep(120);
           +	return mipi_dsi_dcs_set_display_on(ctx->dsi);
           +}
           +
           +static int jd9365da_disable(struct drm_panel *panel) {
           +	struct jd9365da_panel *ctx = to_jd9365da_panel(panel);
           +	return mipi_dsi_dcs_set_display_off(ctx->dsi);
           +}
           +
           +static const struct drm_display_mode jd9365da_mode = {
           +	.clock = 72000,
           +	.hdisplay = 800,
           +	.hsync_start = 800 + 40,
           +	.hsync_end = 800 + 40 + 20,
           +	.htotal = 800 + 40 + 20 + 20,
           +	.vdisplay = 1280,
           +	.vsync_start = 1280 + 20,
           +	.vsync_end = 1280 + 20 + 4,
           +	.vtotal = 1280 + 20 + 4 + 20,
           +	.flags = DRM_MODE_FLAG_NHSYNC | DRM_MODE_FLAG_NVSYNC,
           +};
           +
           +static int jd9365da_get_modes(struct drm_panel *panel, struct drm_connector *connector) {
           +	struct drm_display_mode *mode = drm_mode_duplicate(connector->dev, &jd9365da_mode);
           +	if (!mode) return -ENOMEM;
           +	drm_mode_set_name(mode);
           +	mode->type = DRM_MODE_TYPE_DRIVER | DRM_MODE_TYPE_PREFERRED;
           +	drm_mode_probed_add(connector, mode);
           +	return 1;
           +}
           +
           +static const struct drm_panel_funcs jd9365da_funcs = {
           +	.prepare = jd9365da_prepare,
           +	.enable = jd9365da_enable,
           +	.disable = jd9365da_disable,
           +	.get_modes = jd9365da_get_modes,
           +};
           +
           +static int jd9365da_dsi_probe(struct mipi_dsi_device *dsi) {
           +	struct jd9365da_panel *ctx = devm_kzalloc(&dsi->dev, sizeof(*ctx), GFP_KERNEL);
           +	if (!ctx) return -ENOMEM;
           +	mipi_dsi_set_drvdata(dsi, ctx);
           +	ctx->dsi = dsi;
           +	ctx->reset_gpio = devm_gpiod_get(&dsi->dev, "reset", GPIOD_OUT_LOW);
           +	if (IS_ERR(ctx->reset_gpio)) return dev_err_probe(&dsi->dev, PTR_ERR(ctx->reset_gpio), "No reset GPIO\n");
           +	drm_panel_init(&ctx->panel, &dsi->dev, &jd9365da_funcs, DRM_MODE_CONNECTOR_DSI);
           +	drm_panel_add(&ctx->panel);
           +	dsi->mode_flags = MIPI_DSI_MODE_VIDEO | MIPI_DSI_MODE_VIDEO_BURST | MIPI_DSI_MODE_LPM;
           +	dsi->format = MIPI_DSI_FMT_RGB888;
           +	dsi->lanes = 4;
           +	return mipi_dsi_attach(dsi);
           +}
           +
           +static void jd9365da_dsi_remove(struct mipi_dsi_device *dsi) {
           +	struct jd9365da_panel *ctx = mipi_dsi_get_drvdata(dsi);
           +	mipi_dsi_detach(dsi);
           +	drm_panel_remove(&ctx->panel);
           +}
           +
           +static const struct of_device_id jd9365da_of_match[] = { { .compatible = "qy,qy101003a0-00", }, { } };
           +MODULE_DEVICE_TABLE(of, jd9365da_of_match);
           +static struct mipi_dsi_driver jd9365da_driver = {
           +	.probe = jd9365da_dsi_probe,
           +	.remove = jd9365da_dsi_remove,
           +	.driver = { .name = "panel-jd9365da-h3", .of_match_table = jd9365da_of_match, },
           +};
           +module_mipi_dsi_driver(jd9365da_driver);
           +MODULE_LICENSE("GPL");
           +EOF

                    # =======================================================
          # 2. ç”Ÿæˆè®¾å¤‡æ ‘è¡¥ä¸ (DTS) - æœ€ç»ˆä¿®æ­£ç‰ˆ (è™šæ‹ŸèƒŒå…‰)
          # =======================================================
          cat << 'EOF' > $PATCH_DIR/002-rk3566-tspi-fixes.patch
          diff --git a/arch/arm64/boot/dts/rockchip/rk3566-lckfb-tspi.dts b/arch/arm64/boot/dts/rockchip/rk3566-lckfb-tspi.dts
          index xxxxx..xxxxx 100644
          --- a/arch/arm64/boot/dts/rockchip/rk3566-lckfb-tspi.dts
          +++ b/arch/arm64/boot/dts/rockchip/rk3566-lckfb-tspi.dts
          @@ -20,6 +20,14 @@
           		stdout-path = "serial2:1500000n8";
           	};
           
          +	/* ä¿®å¤1ï¼šå®šä¹‰ä¸€ä¸ªè™šæ‹Ÿçš„å›ºå®šç”µå‹èƒŒå…‰è°ƒèŠ‚å™¨ */
          +	/* å› ä¸ºå±å¹•æ²¡æœ‰BL_ENå¼•è„šï¼Œæˆ‘ä»¬å‡è®¾æ¿å­ä¸€ä¸Šç”µèƒŒå…‰å°±äº®ï¼Œæˆ–è€…ç”±ç¡¬ä»¶è‡ªåŠ¨æ§åˆ¶ */
          +	panel_backlight: panel-backlight {
          +		compatible = "regulator-fixed";
          +		regulator-name = "panel-backlight";
          +		regulator-min-microvolt = <3300000>;
          +		regulator-max-microvolt = <3300000>;
          +		gpio = <&gpio3 RK_PA2 GPIO_ACTIVE_HIGH>; /* ä»ç„¶ä¿ç•™è¿™ä¸ªè„šä½œä¸ºä½¿èƒ½è„šï¼Œä¸‡ä¸€æ¿å­ä¸Šæœ‰MOSç®¡æ§åˆ¶å‘¢ */
          +		enable-active-high;
          +		regulator-always-on;
          +		regulator-boot-on;
          +	};
          +
           	vcc12v_dcin: vcc12v-dcin {
           		compatible = "regulator-fixed";
           		regulator-name = "vcc12v_dcin";
          @@ -100,6 +108,65 @@
           	status = "okay";
           };
          
          +/* ========================================== */
          +/* ä¿®å¤3ï¼šMIPI å±å¹•é…ç½® (JD9365DA-H3)         */
          +/* ========================================== */
          +&dsi0 {
          +	status = "okay";
          +	#address-cells = <1>;
          +	#size-cells = <0>;
          +
          +	panel@0 {
          +		compatible = "qy,qy101003a0-00";
          +		reg = <0>;
          +		/* Reset: AP4 = GPIO3_C1 = RK_PC1 */
          +		reset-gpios = <&gpio3 RK_PC1 GPIO_ACTIVE_LOW>;
          +		
          +		/* è¿™é‡Œçš„ power-supply æŒ‡çš„æ˜¯é€»è¾‘ç”µæº VDD (Pin 30/31) */
          +		power-supply = <&vcc3v3_sys>;
          +		
          +		/* è¿™é‡Œçš„ backlight æŒ‡çš„æ˜¯ LED+ (Pin 1-3) çš„ä¾›ç”µ */
          +		/* æˆ‘ä»¬ç”¨ä¸Šé¢å®šä¹‰çš„è™šæ‹Ÿè°ƒèŠ‚å™¨æ¥â€œéª—â€è¿‡é©±åŠ¨ */
          +		backlight = <&panel_backlight>;
          +	};
          +};
          +
          +&dsi0_in_vp0 {
          +	status = "okay";
          +};
          +
          +/* ========================================== */
          +/* ä¿®å¤4ï¼šGT911 è§¦æ‘¸é…ç½® (I2C1)               */
          +/* ========================================== */
          +&i2c1 {
          +	status = "okay";
          +	clock-frequency = <400000>;
          +	
          +	touchscreen@5d {
          +		compatible = "goodix,gt911";
          +		reg = <0x5d>;
          +		interrupt-parent = <&gpio1>;
          +		interrupts = <RK_PA0 IRQ_TYPE_LEVEL_LOW>;
          +		reset-gpios = <&gpio1 RK_PA1 GPIO_ACTIVE_LOW>;
          +		irq-gpios = <&gpio1 RK_PA0 GPIO_ACTIVE_HIGH>;
          +	};
          +};
          +EOF


                  # =======================================================
          # 3. å¼ºåˆ¶å¼€å¯å†…æ ¸é…ç½® (æš´åŠ›æ³¨å…¥ç‰ˆ)
          # =======================================================
          # æˆ‘ä»¬ä¸æ”¹ board-station-m2.configï¼Œç›´æ¥æ”¹å†…æ ¸æºç é‡Œçš„ defconfig
          # è¿™æ ·ç¼–è¯‘è„šæœ¬ç”Ÿæˆ .config æ—¶å°±å¿…é¡»åŒ…å«æˆ‘ä»¬çš„é©±åŠ¨
          
          # æ‰¾åˆ°å†…æ ¸æºç ç›®å½• (åœ¨ compile.sh è¿è¡Œå‰ï¼Œæºç ä¼šè¢«è§£å‹åˆ° cache/sources/...)
          # ä½†åœ¨ userpatches é˜¶æ®µï¼Œæˆ‘ä»¬åªèƒ½é€šè¿‡ config æ–‡ä»¶æ¥å½±å“
          
          # æ–¹æ¡ˆ A: å†™å…¥æ‰€æœ‰å¯èƒ½çš„ config æ–‡ä»¶ï¼Œç¡®ä¿å‘½ä¸­
          echo "CONFIG_DRM_PANEL_JD9365DA_H3=y" >> $PATCH_DIR/board-station-m2.config
          echo "CONFIG_TOUCHSCREEN_GOODIX=y" >> $PATCH_DIR/board-station-m2.config
          
          # æ–¹æ¡ˆ B: åˆ›å»ºä¸€ä¸ªä¸“é—¨çš„å†…æ ¸é…ç½®ç‰‡æ®µ (fragment)
          # Armbian ç¼–è¯‘ç³»ç»Ÿä¼šè‡ªåŠ¨åŠ è½½ userpatches/kernel/rockchip64-current/ ä¸‹çš„ .config æ–‡ä»¶
          echo "CONFIG_DRM_PANEL_JD9365DA_H3=y" > $PATCH_DIR/my-screen.config
          echo "CONFIG_TOUCHSCREEN_GOODIX=y" >> $PATCH_DIR/my-screen.config
          
          # æ–¹æ¡ˆ C: ç¡®ä¿ Kconfig è¡¥ä¸é‡Œçš„åå­—å’Œè¿™é‡Œä¸€è‡´
          # æ£€æŸ¥ä¸€ä¸‹ Step 1 é‡Œçš„ Kconfig è¡¥ä¸ï¼Œæˆ‘ä»¬å®šä¹‰çš„æ˜¯:
          # config DRM_PANEL_JD9365DA_H3
          # æ‰€ä»¥è¿™é‡Œå¿…é¡»æ˜¯ CONFIG_DRM_PANEL_JD9365DA_H3=y
          
          # æ‰“å°ä¸€ä¸‹ï¼Œç¡®è®¤æ–‡ä»¶ç”Ÿæˆäº†
          ls -l $PATCH_DIR/
          cat $PATCH_DIR/my-screen.config



      - name: Compile Armbian [ ${{ inputs.set_release }} ]
        id: compile
        working-directory: /builder
        if: ${{ steps.down.outputs.status }} == 'success' && !cancelled()
        run: |
          # Compile method and parameter description: https://docs.armbian.com/Developer-Guide_Build-Options
          cd build/
              ./compile.sh RELEASE=${{ inputs.set_release }} BOARD=odroidn2 BRANCH=current BUILD_MINIMAL=no \
                           BUILD_ONLY=default HOST=armbian BUILD_DESKTOP=no EXPERT=yes KERNEL_CONFIGURE=no \
                           COMPRESS_OUTPUTIMAGE="sha" SHARE_LOG=yes
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: Organize files and clear space
        id: clean
        if: ${{ steps.compile.outputs.status }} == 'success' && !cancelled()
        run: |
          # Organize and keep essential files, delete unnecessary files
          chmod +x ${ROOTFS_SCRIPT}
          ${ROOTFS_SCRIPT} -v ${{ inputs.set_release }} -s true -c true -k true -p arm64

          # Clean build directory except output folder
          cd build/
          rm -rf $(ls . | grep -v "^output$" | xargs) 2>/dev/null

          # Output cleaning result information
          df -hT ${PWD}
          echo "build_tag=Armbian_${{ inputs.set_release }}_arm64_${{ inputs.armbian_edition }}_$(date +"%Y.%m")" >> ${GITHUB_ENV}
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: Upload Armbian image to Release
        uses: ncipollo/release-action@main
        if: ${{ steps.clean.outputs.status }} == 'success' && !cancelled()
        with:
          tag: ${{ env.build_tag }}
          artifacts: build/output/images/*
          allowUpdates: true
          makeLatest: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Rebuild Armbian
        uses: ophub/amlogic-s9xxx-armbian@main
        if: ${{ steps.clean.outputs.status }} == 'success' && !cancelled()
        with:
          build_target: armbian
          armbian_path: build/output/images/*.img.gz
          armbian_board: ${{ inputs.armbian_board }}
          armbian_kernel: ${{ inputs.armbian_kernel }}
          auto_kernel: ${{ inputs.auto_kernel }}
          kernel_repo: ${{ inputs.kernel_repo }}
          kernel_usage: ${{ inputs.kernel_usage }}
          armbian_fstype: ${{ inputs.armbian_fstype }}
          builder_name: ${{ inputs.builder_name }}

      - name: Upload Rebuild image to Release
        uses: ncipollo/release-action@main
        if: ${{ env.PACKAGED_STATUS }} == 'success' && !cancelled()
        with:
          tag: ${{ env.build_tag }}
          artifacts: ${{ env.PACKAGED_OUTPUTPATH }}/*
          allowUpdates: true
          removeArtifacts: false
          replacesArtifacts: true
          makeLatest: true
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            ### Armbian Image information
            - Default username: `root`
            - Default password: `1234`
            - Install command: `armbian-install`
            - Update command: `armbian-update`
            ### Applicable platform
            - ğŸ§ `arm64`
            - ğŸ‹ Docker image: https://hub.docker.com/u/ophub
